#  数据库恢复技术

数据库恢复技术是数据库管理系统的重要组成部分，是一种事务处理技术；
> 事务处理技术主要包括**数据库恢复技术和并发控制技术**

## 事务的基本概念和特征

### 事务的基本概念

+ 事务(Transaction)是**用户定义的一个数据库操作序列**，这些操作要么全做，要么全不做，是一个不可分割的工作单位
+ 事务是**一系列的数据库操作，事务是恢复和并发控制的基本单位**
+ 事务和程序是两个概念
+ 在关系数据库中，一个事务可以是**一条SQL语句，一组SQL语句或整个程序**
+ 一个应用程序通常包含多个事务

### 事务的特征

原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持续性（Durability ），简称**ACID特性**

+ 原子性（Atomicity）
    
    事务是数据库的逻辑工作单位，事务中包括的诸操作要么都做，要么都不做

+ 一致性（Consistency）
    
    事务执行的结果必须是使数据库从一个一致性状态变到另一个一致性状态
    
    一致性状态：数据库中只包含成功事务提交的结果
    不一致状态：数据库中包含失败事务的结果

+ 隔离性（Isolation）

    + 对并发执行而言,一个事务的执行不能被其他事务干扰
    + 一个事务内部的操作及使用的数据对其他并发事务是隔离的
    + 并发执行的各个事务之间不能互相干扰

+ 持续性（Durability）

    一个事务一旦提交，它对数据库中数据的改变就应该是永久性的

### 事务的状态

**事务中止：由于系统故障等原因事务无法成功执行而处于中止状态**

> **为了保证事务的原子性，中止事务不能破坏数据库的一致性状态。**系统有两种方法处理事务中止

+ 重启事务：由于硬件错误

+ 杀死事务：由于事务内部逻辑错误

**事务回滚：数据库恢复到事务执行前的状态** 

+ 活动状态：事务执行时处于活动状态

+ 部分提交状态：事务的最后一条语句执行完毕，事务进入部分提交状态，结果数据还在内存中

+ 失败状态：事务不能正常执行，事务进入失败状态，需要回滚，撤销书屋已经做出的任何数据更改

+ 中止状态：事务回滚且数据库已经恢复到事务执行前的状态

+ 提交状态：**当数据库系统将事务中对数据的更改完全写入磁盘时**，写入一条事务日志消息，标志着事务完成，更新结构转存到永久存储器上

![](./img/8-1.png)

## 数据库恢复的必要性

**保证事务的原子性不被破坏**

故障大致可以分为如下几类：

+ 系统故障
+ 事务内部的故障
+ 存储设备故障
+ 其他原因

### 系统故障

系统故障是指造成系统停止运行的任何事件，如：硬件故障、操作系统故障或DBMS故障等，所有正在执行的事务中断，内存中事务数据丢失，数据可能处于不一致状态

### 事务内部的故障

两种：

1. 可由应用程序发现的

2. **非预期、无法由应用程序发现的**，比如死锁、运算溢出等，应当**由系统予以处理**。**事务故障仅指这类故障**

### 存储设备故障

主要指辅助存储的介质遭到破坏，这类故障不但影响着活动者的所有事务，而且使被损坏介质的数据丢失，数据库遭到严重破坏

## 数据库恢复技术

数据恢复的基本原理：**利用存储在系统其它地方的冗余数据来重建数据库中已被破坏或不正确的那部分数据**

**建立冗余数据**可以通过：**数据转储和登记日志文件**

**恢复子系统的功能**是利用冗余数据，再**根据故障的类型采取相应的恢复措施**，保证故障发生后，能**把数据库中的数据从错误状态恢复到某种逻辑一致的状态**

### 数据转储

**数据转储是数据库恢复中采用的基本技术**

> 只能恢复到转储时状态

数据转储是指**定期地将整个数据库复制到磁带或另一个磁盘上保存起来的过程**，这些备用的数据文本称为**后备副本或后援副本**

#### 静态转储和动态转储

+ 静态转储：在系统无运行事务时进行转储，实现简单，**保持了数据库的一致性**，但是降低了数据库的可用性

+ 动态转储：转储与用户事务并发进行，不影响事务的运行，但是不能保证副本中数据正确有效，需要配合日志进行恢复

#### 海量转储和增量转储

+ 海量转储：转储全部数据库

+ 增量转储：只转储上次转储后更新的数据

### 基于日志的数据库恢复

> **登记的次序严格按并行事务执行的时间次序；必须先写日志文件，后写数据库**

日志：**记录有关事务的数据库操作信息**，分为：

+ **以记录为单位的日志文件**

    记录内容：事务标识、操作类型、操作对象、更新前后的数据值

    1. < Start Ti >，表示事务Ti开始。
    2. < Ti, Xj, V1, V2 >，表示事务Ti对数据项Xj执行写操作。旧值是V1,新值是V2。
    3. < Commit Ti >，表示事务Ti已提交。事务对数据库所做的任何更新都写入到数据缓冲区中，通常不能确定磁盘是否已经进行更新
    4. < Abort Ti >，表示事务Ti已中止。表明事务不能成功完成。如果事务中止，系统将确保这一事务的更新不会对数据库造成影响

+ **以数据块为单位的日志文件**

    记录内容：事务标识和被更新的数据块

#### 日志文件的作用

+ **事务故障恢复和系统故障恢复**必须用日志文件

+ **介质故障恢复**必须用日志文件

+ 在**动态转储方式**中必须建立日志文件，**后备副本与该日志文件**综合起来才能将数据库恢复到一致性状态

+ 可以与静态转储后备副本配合进介质故障恢复

#### 基于日志的数据库恢复技术

+ Redo技术

    当事务提交时，日志保存了事务对数据库更新的信息，如果发生故障，可以用Redo操作重做事务，**恢复已完成的事务**

+ Undo技术

    在事务执行过程中修改了数据库而**事务还没提交**，此时如果系统崩溃，可以利用Undo恢复技术**撤销事务**，**将被修改的数据项恢复到事务开始前的状态**

    Undo操作的过程： 

    + 检查日志文件，寻找事务Ti执行write(X)操作前写入日志的记录，

    + 把数据库中的X项的值重新修改为更新前的旧值

    + 如果事务Ti有多个write操作，Undo write操作的顺序必须与write操作时写入的顺序相反

+ 恢复子系统通过检查日志文件决定事务执行redo还是undo

## 提高恢复效率的技术

### 检查点技术

检查点是**记录在日志中表示数据库是否正常运行的一个标志**，以记录所有当前活动的事务

#### 检查点记录的内容： 

+ 建立检查点时刻所有正在执行的事务清单

+ 这些事务最近一个日志记录的地址

#### 写检查点的操作顺序：

> 在写检查点过程中，不允许事务执行任何更新操作，如：写缓冲块和写日志记录

+ 将日志缓冲区中的内容写入日志文件

+ 在日志文件中写入一个检查点记录

+ 将数据库缓冲区的内容写入数据库

+ 把检查点记录在日志文件中的地址写入重启动文件

#### 具有检查点的恢复步骤为：

+ 读取重启文件，获取最后一个检查点记录的地址

+ 得到检查点时刻的事务清单

+ 正向扫描日志文件，对已经完成的事务执行 Redo 操作，对未完成的事务执行 Undo 操作

### 数据库镜像恢复技术

> 可以改善介质故障的恢复效率

在不同的设备上同时存在两份数据库，一个是主设备，另一个是镜像设备。所谓镜像的含义是指每当主设备的数据库发生更新时，系统自动更新镜像设备的数据，使得两个设备的数据始终保持一致。一旦主设备出现故障，可以由镜像设备继续提供数据。

## 数据库恢复策略

### 事务故障的恢复 Redo

事务故障：事务在运行至正常终止点前被中止

恢复方法：**利用日志文件撤销事务对数据的更改，系统回滚到事务执行前的状态**

系统故障的恢复**由系统在重新启动时**自动完成，不需要用户干预

(1) 反向扫描文件日志，查找该事务的更新操作。
(2) 对该事务的更新操作执行逆操作。即将日志记录中“更新前的值”写入数据库。
(3) 继续反向扫描日志文件，查找该事务的其他更新操作，并做同样处理。
(4) 如此处理下去，直至读到此事务的开始标记。

### 系统故障的恢复 Redo+Undo

系统故障造成数据库不一致状态的原因

+ 一些未完成事务对数据库的更新已写入数据库
+ 一些已提交事务对数据库的更新还留在缓冲区没来得及写入数据库

恢复步骤：

1. 正向扫描日志文件（即从头扫描日志文件）

Redo队列:在故障发生前已经提交的事务
Undo队列:故障发生时尚未完成的事务

2. 对Undo队列事务进行UNDO处理

反向扫描日志文件，对每个UNDO事务的更新操作执行逆操作

3. 对Redo队列事务进行REDO处理

正向扫描日志文件，对每个REDO事务重新执行登记的操作

### 介质故障的恢复 Redo+Undo+备份

事务的持久性要求已提交事务写入的信息不能丢失，因此需要考虑介质故障

需要后援副本和日志文件一起完成恢复

根据后备副本重建数据库，用运行日志重做副本备份后已完成的事务

介质故障的恢复需要DBA介入

+ 重装最近转储的数据库副本和相关日志文件副本
+ 执行系统提供的恢复命令
+ 具体的恢复操作仍由DBMS完成
