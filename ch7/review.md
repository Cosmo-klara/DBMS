# 数据库的完整性

数据库的完整性是指**数据的正确性, 有效性和相容性**

+ 正确性: 数据的合法性
+ 有效性: 数据是否输入定义的有效范围
+ 相容性: 表示同一事实的两个数据应该相同

为维护数据库的完整性，DBMS提供功能:

+ 提供定义完整性约束条件的机制

    > 完整性约束条件的作用对象可以是：关系、元组和属性（列）

+ 提供完整性检查的方法

+ 违约处理: 即如果发现用户的操作请求使数据违背了完整性约束条件，则采取一定的动作来保证数据的完整性

## 完整性约束条件分类

### 根据对象

> 完整性约束条件作用的对象可以是**关系、元组、和属性(列)**

+ **列级约束：对数据的数据类型、数据格式、取值范围和精度等的约束**

    + 对数据具体类型的约束，包括数据类型、长度、精度等

    + 对数据格式的约束，比如日期的格式

    + 对取值域的约束，比如限定取值在0~100之间

    + 对空值的约束，比如不允许为空值

+ **元组约束：各个属性之间的约束**，比如某个属性的值必须大于另一个属性的值等，常用于日期的约束

+ **关系约束：一个关系的各个元组之间或多个关系之间存在的各种联系或约束**；常见的关系约束有：**实体完整性约束、参照完整性约束、函数依赖约束、统计约束等**

    > 统计约束：比如部门经理的工资不得高于本部门职工平均工资的5倍，**先统计数据在约束原关系**
    
> 完整性约束还可根据**作用的对象状态不同**，划分为**静态约束和动态约束**

+ **静态约束：数据库每一确定状态时数据对象需要满足的约束条件**

+ **动态约束：当数据库状态转变时，新旧数据之间需要满足的约束条件**

### 根据方法

对于能**用声明完整性实现**的约束条件，尽量用声明完整性约束实现，这样的**执行效率比较高**

**约束、默认值、规则**可用来实现**声明完整性**

> 在服务器实现数据完整性有两个方法：

+ **声明完整性：在定义表时声明数据完整性**

    > 作为关系模式定义的一部分来定义数据的标准，主要通过使用**约束、默认值和规则**来实现；

+ **过程完整性：在服务器编写触发器实现数据完整性**
    
    > 在程序中定义数据的标准，在程序中强制完整性，通过使用**触发器和存储过程**来实现；触发器是过程完整性，优先级在声明完整性之后

## 实现数据库完整性的方法

在关系数据库系统中，数据完整性控制策略包括规则、默认值、约束和触发器等。

+ 默认值

如果在插入行中没有指定列的值，那么默认值指定列中所使用的值，例如：自动增长值，内置函数、数学表达式等

+ 约束

约束是自动强制数据完整性的方法。

约束定义关系列中允许值的规则，是通用的强制完整性的标准机制。

**使用约束优于使用触发器、规则和默认值**

+ 规则

规则是大多数数据库系统中一个向后兼容的功能，用于执行一些与CHECK约束相同的功能。规则以单独的对象创建，然后绑定到列上

+ 触发器

**触发器是数据库系统中强制业务规则和数据完整性的主要机制**

## 实体完整性 

检查: 

1. 主键是否唯一
2. 主键各属性字段是否非空

## 参照完整性

不仅存在与关系之间, 同一关系内部属性之间也有参照约束关系. 核心是**不允许引用不存在的元组**

1. 从表插入元组依赖值不存在于主表
2. 从表修改依赖值不存在于主表
3. 主表删除元组导致从表失去依赖值
4. 主表修改值导致从表失去依赖值

### 维护参照完整性的策略

+ 参照关系中外键空值的问题
    
    > 需要定义外键是否允许为空值
    
    + 如果外键是其主键的组成部分，外键值不允许为空, 否则可以根据具体的语义确定外键值是否允许空值

+ 在参照关系中插入元组的问题(修改操作与之类似)
    + 受限插入
        向titles中插入新的元组，但该元组的pub_id属性值在表publishers中不存在，则系统拒绝
    + 级联(CASCADE)插入
        首先向被参照关系插入相应的元组，其主键值等于参照关系插入元组的外键值，然后再向参照关系插入该元组在被参照关系中删除元组的问题

    + 级联删除（CASCADES）
    + 受限删除（RESTRICTED）
    + 置空值删除

## 用户定义的完整性

用户定义的完整性反映应用领域需要遵循的约束条件，体现了具体领域中的语义约束, 用户定义后由系统支持

+ 在关系数据库系统中，数据完整性控制策略包括规则、默认值、约束、触发器和存储过程等。

通常属性上的约束条件包括
+ 唯一约束(UNIQUE)
+ 非空约束(NOT NULL)
+ 默认值约束(DEFAULT)
+ 检查约束(CHECK)


## 触发器

触发器是**一种需要编程实现的完整性控制策略**, 触发器是完整性控制策略中**数据控制能力最灵活**的

触发器是一种特殊类型的存储过程，在对表或视图发出 UPDATE、INSERT 或 DELETE 语句时自动执行

### 优点(可用触发器完成很多数据库完整性保护的功能): 

+ 实现复杂的业务规则
+ 实现比CHECK 约束更复杂的数据完整性。
+ 比较数据修改前后的状态
+ 维护非规范化数据
